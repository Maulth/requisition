machine:
  environment:
    RAILS_ENV: test
    RACK_ENV: test

dependencies:
  pre:
    - ruby -v
    - gem install bundler
  bundler:
    without: [production, development, doc]
  post:
    - bundle exec rails assets:precompile

database:
  override:
    - bundle exec rails db:create db:migrate
  post:
    - git status --short && test "$(git status --short)" = "?? public/assets/"

test:
  pre:
    - bundle exec rubocop --rails --fail-level=warning --display-cop-names --format=progress --format=offenses --format=html --out="$CIRCLE_ARTIFACTS/rubocop.html"
  override:
    - bundle exec rails test TESTOPTS="--ci-dir=$CIRCLE_TEST_REPORTS":
        parallel: true
        files:
          - test/**/*_test.rb
