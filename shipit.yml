machine:
  environment:
    APP_PRODUCTION: space-dolphins
    APP_STAGING: space-dolphins-staging

tasks:
  restart:
    action: "Restart"
    description: "Sometimes needed if you want the application to restart but don't want to ship any new code."
    steps:
      - bundle exec rake shipit:restart

fetch:
  - bundle exec rake shipit:version

dependencies:
  pre:
    - gem install bundler

deploy:
  override: |
    if [ ENVIRONMENT == 'production' ]; then APP_NAME=$APP_PRODUCTION; else APP_NAME=$APP_STAGING; fi
    bundle exec dpl --provider=heroku --app=$APP_NAME --api-key=$HEROKU_API_KEY;
    curl -n -X POST "https://api.heroku.com/apps/$APP_NAME/ps" -H "Accept: application/json" -H "Authorization: Bearer ${HEROKU_API_KEY}" -d "command=bundle exec rake db:migrate"
