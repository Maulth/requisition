#!/usr/bin/env bash

set -x

if [ "$ENVIRONMENT" = "production" ]; then
  APP_NAME="$APP_PRODUCTION";
else
  APP_NAME="$APP_STAGING";
fi

bundle exec dpl --provider=heroku --app=$APP_NAME --api-key=$HEROKU_API_KEY;
curl -n -X POST "https://api.heroku.com/apps/$APP_NAME/dynos" \
  -H "Accept: application/vnd.heroku+json; version=3" -H "Authorization: Bearer ${HEROKU_API_KEY}" \
  -H "Content-Type: application/json" \
  -d '{
    "attach": true,
    "command": "bundle exec rake db:migrate",
    "type": "run"
  }';
